<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <title>Billion Dollar Ballin</title>
    <style>
        *, html, body {
            margin: 0px;
            padding: 0px;
            overflow: hidden;
        }
        body {
            background-color: #1d273c;
        }
        @font-face {
            font-family: 'font';
            src: url('./assets/font/FFFFORWA.TTF') format('truetype');
        }
        .fontload {
            visibility: hidden;
            position: absolute;
            left: -9999px;
        }
        #walletUI {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            font-family: 'font', sans-serif;
            z-index: 10;
        }
        #gameCanvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
        }
        #connectWallet {
            background: url('./assets/sprites/btn-home.png') no-repeat center, url('./assets/desktop/sprites/btn-home.png') no-repeat center, #f28c38;
            background-size: 100% 100%;
            width: 200px;
            height: 60px;
            padding: 0;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-family: 'font', sans-serif;
            color: white;
            text-shadow: 1px 1px 2px #000;
            display: block;
            margin: 10px auto;
        }
        #playButton, #practiceButton {
            background: url('./assets/sprites/btn-replay.png') no-repeat center, url('./assets/desktop/sprites/btn-replay.png') no-repeat center, #f28c38;
            background-size: 100% 100%;
            width: 200px;
            height: 60px;
            padding: 0;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-family: 'font', sans-serif;
            color: white;
            text-shadow: 1px 1px 2px #000;
            display: none;
            margin: 10px auto;
        }
        #playerName {
            margin: 10px auto;
            padding: 10px;
            width: 180px;
            font-family: 'font', sans-serif;
            font-size: 18px;
            border-radius: 10px;
            border: none;
            display: block;
        }
        #walletStatus, #pot, #highScore, #score, #timer {
            margin: 10px;
            font-size: 16px;
            text-shadow: 1px 1px 1px #000;
        }
        @media (max-width: 600px) {
            #connectWallet, #playButton, #practiceButton {
                width: 120px;
                height: 40px;
                font-size: 14px;
            }
            #playerName {
                width: 100px;
                font-size: 14px;
            }
            #gameCanvas {
                width: 100%;
                height: auto;
                max-width: 400px;
                max-height: 600px;
            }
        }
    </style>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>
<body>
    <div class="fontload" style="font-family: 'font';">.</div>
    <canvas id="gameCanvas" width="400" height="600"></canvas>
    <div id="walletUI">
        <input type="text" id="playerName" placeholder="Enter Name">
        <button id="connectWallet">Connect Wallet</button>
        <button id="playButton">Play (0.0025 SOL)</button>
        <button id="practiceButton">Practice Offline</button>
        <p id="walletStatus">Wallet not connected</p>
        <p id="pot">Pot: 0 SOL</p>
        <p id="highScore">Daily High: 0</p>
        <p id="score">Score: 0</p>
        <p id="timer">Time: 60s</p>
    </div>
    <script>
        let usePhaser = false;
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);
        console.log('Device:', isMobile ? 'Mobile' : 'Desktop');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const ballImg = new Image(); ballImg.src = isMobile ? './assets/sprites/ball.png?v=1' : './assets/desktop/sprites/ball-sheet.png?v=1';
        const hoopTopImg = new Image(); hoopTopImg.src = isMobile ? './assets/sprites/hoop-top.png?v=1' : './assets/desktop/sprites/hoop.png?v=1';
        const hoopBotImg = new Image(); hoopBotImg.src = isMobile ? './assets/sprites/hoop-bot.png?v=1' : './assets/desktop/sprites/hoop.png?v=1';
        const bgImg = new Image(); bgImg.src = isMobile ? './assets/background.png?v=1' : './assets/desktop/sprites/bg.png?v=1';

        ballImg.onerror = () => console.error('Failed to load ball image:', ballImg.src);
        hoopTopImg.onerror = () => console.error('Failed to load hoop top:', hoopTopImg.src);
        hoopBotImg.onerror = () => console.error('Failed to load hoop bot:', hoopBotImg.src);
        bgImg.onerror = () => console.error('Failed to load background:', bgImg.src);

        let ball = { x: 50, y: 300, velocity: 0, gravity: 0.5, jump: -10 };
        let hoop = null;
        let score = 0;
        let gameRunning = false;
        let walletPublicKey = null;
        let timeLeft = 60;
        let timerInterval = null;
        let dailyHighScore = 0;
        let pot = 0;

        const playerNameInput = document.getElementById('playerName');
        const connectButton = document.getElementById('connectWallet');
        const playButton = document.getElementById('playButton');
        const practiceButton = document.getElementById('practiceButton');
        const walletStatus = document.getElementById('walletStatus');
        const potDisplay = document.getElementById('pot');
        const highScoreDisplay = document.getElementById('highScore');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');

        console.log('Checking button image:', connectButton.style.background.includes('btn-home.png') ? 'Loaded' : 'Failed');

        window.addEventListener('load', () => {
            if (!canvas.getContext) console.error('Canvas context failed!');
            ctx.fillStyle = 'red';
            ctx.fillRect(0, 0, 400, 600); // Debug: Should show red canvas
            console.log('Canvas test draw');
            startGame();
        });

        connectButton.addEventListener('click', async () => {
            if (window.solana && window.solana.isPhantom) {
                try {
                    const response = await window.solana.connect();
                    walletPublicKey = response.publicKey.toString();
                    walletStatus.textContent = `Connected: ${walletPublicKey.slice(0, 6)}...`;
                    connectButton.style.display = 'none';
                    practiceButton.style.display = 'none';
                    playButton.style.display = 'block';
                } catch (err) {
                    walletStatus.textContent = 'Connection failed!';
                    console.error(err);
                }
            } else {
                walletStatus.textContent = 'Install Phantom Wallet!';
            }
        });

        playButton.addEventListener('click', async () => {
            if (!walletPublicKey) {
                alert('Connect your wallet first!');
                return;
            }
            if (!playerNameInput.value.trim()) {
                alert('Please enter your name!');
                return;
            }
            await chargeFee();
        });

        practiceButton.addEventListener('click', () => {
            if (!playerNameInput.value.trim()) {
                alert('Please enter your name!');
                return;
            }
            document.getElementById('walletUI').style.display = 'none';
            alert('Starting practice mode...');
            startGame();
        });

        async function chargeFee() {
            const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'), 'confirmed');
            const ownerPublicKey = new solanaWeb3.PublicKey('YOUR_OWNER_WALLET_PUBLIC_KEY');
            const potPublicKey = new solanaWeb3.PublicKey('YOUR_POT_WALLET_PUBLIC_KEY');

            const ownerCut = 0.00025 * solanaWeb3.LAMPORTS_PER_SOL;
            const potAmount = 0.00225 * solanaWeb3.LAMPORTS_PER_SOL;

            const ownerTx = new solanaWeb3.Transaction().add(
                solanaWeb3.SystemProgram.transfer({
                    fromPubkey: new solanaWeb3.PublicKey(walletPublicKey),
                    toPubkey: ownerPublicKey,
                    lamports: ownerCut,
                })
            );

            const potTx = new solanaWeb3.Transaction().add(
                solanaWeb3.SystemProgram.transfer({
                    fromPubkey: new solanaWeb3.PublicKey(walletPublicKey),
                    toPubkey: potPublicKey,
                    lamports: potAmount,
                })
            );

            try {
                const { blockhash } = await connection.getLatestBlockhash();
                ownerTx.recentBlockhash = blockhash;
                ownerTx.feePayer = new solanaWeb3.PublicKey(walletPublicKey);
                potTx.recentBlockhash = blockhash;
                potTx.feePayer = new solanaWeb3.PublicKey(walletPublicKey);

                const signedOwner = await window.solana.signTransaction(ownerTx);
                const signedPot = await window.solana.signTransaction(potTx);

                await connection.sendRawTransaction(signedOwner.serialize());
                const potSignature = await connection.sendRawTransaction(signedPot.serialize());
                await connection.confirmTransaction(potSignature);

                pot += 0.00225;
                potDisplay.textContent = `Pot: ${pot.toFixed(5)} SOL`;
                document.getElementById('walletUI').style.display = 'none';
                alert('Fee paid! Game starting...');
                startGame();
            } catch (err) {
                console.error('Fee payment failed:', err);
                alert('Fee payment failed!');
            }
        }

        function startGame() {
            console.log('startGame called');
            document.getElementById('walletUI').style.display = 'none';
            setTimeout(() => document.getElementById('walletUI').style.display = 'none', 100);
            if (!ballImg.complete || !hoopTopImg.complete || !hoopBotImg.complete || !bgImg.complete) {
                console.log('Images not loaded yet—retrying...');
                if (!ballImg.src) console.error('Image sources not set!');
                setTimeout(startGame, 100);
                return;
            }
            ball.y = 300; ball.velocity = 0;
            hoop = { x: 400, height: 200, passed: false };
            score = 0;
            timeLeft = 60;
            gameRunning = true;
            scoreDisplay.textContent = `Score: ${score}`;
            timerDisplay.textContent = `Time: ${timeLeft}s`;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `Time: ${timeLeft}s`;
                if (timeLeft <= 0) gameOver();
            }, 1000);
            gameLoop();
        }

        function gameLoop() {
            if (!gameRunning) return;
            document.getElementById('walletUI').style.display = 'none';
            ctx.drawImage(bgImg, 0, 0, 400, 600);
            ball.velocity += ball.gravity;
            ball.y += ball.velocity;
            ctx.drawImage(ballImg, ball.x, ball.y, 30, 30);

            hoop.x -= 2;
            ctx.drawImage(hoopTopImg, hoop.x, 0, 50, hoop.height);
            ctx.drawImage(hoopBotImg, hoop.x, hoop.height + 150, 50, 600 - hoop.height - 150);

            if (hoop.x + 50 < ball.x && !hoop.passed) {
                score++;
                scoreDisplay.textContent = `Score: ${score}`;
                hoop = { x: 400, height: Math.random() * 300 + 50, passed: false };
            }

            if (ball.x + 30 > hoop.x && ball.x < hoop.x + 50 &&
                (ball.y < hoop.height || ball.y + 30 > hoop.height + 150)) {
                gameOver();
                return;
            }

            if (hoop.x < -50) hoop = { x: 400, height: Math.random() * 300 + 50, passed: false };

            if (ball.y > 600 || ball.y < 0) gameOver();

            requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            gameRunning = false;
            clearInterval(timerInterval);
            alert(`Game Over! Score: ${score}`);
            if (score > dailyHighScore) {
                dailyHighScore = score;
                highScoreDisplay.textContent = `Daily High: ${dailyHighScore}`;
            }
            document.getElementById('walletUI').style.display = 'block';
            connectButton.style.display = walletPublicKey ? 'none' : 'block';
            playButton.style.display = walletPublicKey ? 'block' : 'none';
            practiceButton.style.display = walletPublicKey ? 'none' : 'block';
            setTimeout(() => {
                if (!gameRunning) {
                    document.getElementById('walletUI').style.display = 'block';
                    console.log('UI shown after game over');
                }
            }, 200);
        }

        document.addEventListener('keydown', () => {
            if (gameRunning) ball.velocity = ball.jump;
        });
        document.addEventListener('touchstart', (e) => {
            if (gameRunning && e.target.tagName !== 'INPUT') {
                ball.velocity = ball.jump;
                e.preventDefault();
                ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.fillRect(ball.x, ball.y, 30, 30);
                setTimeout(() => {
                    ctx.drawImage(bgImg, ball.x, ball.y, 30, 30);
                    ctx.drawImage(ballImg, ball.x, ball.y, 30, 30);
                }, 100);
            }
        }, { passive: false });

        setInterval(() => {
            if (pot > 0) {
                console.log(`Daily payout: 95% (${(pot * 0.95).toFixed(5)} SOL) to high scorer, 5% (${(pot * 0.05).toFixed(5)} SOL) to owner`);
                pot = 0;
                dailyHighScore = 0;
                potDisplay.textContent = `Pot: 0 SOL`;
                highScoreDisplay.textContent = `Daily High: 0`;
            }
        }, 24 * 60 * 60 * 1000);

        window.addEventListener('load', () => {
            usePhaser = typeof Phaser !== 'undefined';
            console.log(usePhaser ? 'Phaser detected—using bundled JS' : 'No Phaser—using canvas logic');
            if (usePhaser) console.log('Check for vendorsLoaded:', typeof vendorsLoaded !== 'undefined');
        });
    </script>
</body>
</html>
